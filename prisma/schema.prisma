// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ROOTADMIN
  ADMIN
  AGENT
  TRAVELER
}

enum AddressType {
  PERMANENT
  CURRENT
  TRAVEL
}

enum RoleStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BookingStatus {
  PENDING
  HOLD
  CONFIRMED
  CANCELLED
  COMPLETED
  REFUND_PENDING
  REFUNDED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentType {
  ADVANCE
  FINAL
  REFUND
}

enum ProviderType {
  STRIP
  RAZORPAY
  OTHER
}

enum NotificationType {
  BOOKING_UPDATE
  PAYMENT_UPDATE
  SYSTEM_MESSAGE
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
}

enum CancelledBy {
  USER
  AGENT
  PLATFORM
}

enum DocumentType {
  AADHAR
  PAN
}

enum TransportMode {
  BUS
  TRAIN
  CAR
  FLIGHT
  BOAT
  WALK
  OTHER
}

enum ReviewType {
  AGENT
  PACKAGE
  PLATFORM
}

model Bb_user {
  id        String   @id @default(cuid())
  fullName  String
  email     String   @unique
  password  String? // null if Google OAuth only
  emailVerified  Boolean  @default(false)
  role      UserRole @default(TRAVELER)
  roleStatus RoleStatus?
  phone     String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isDeleted Boolean  @default(false)

  profileImageId String? @unique
  profileImage   Bb_image?  @relation("User_profileImage", fields: [profileImageId], references: [id])

  refreshToken  String?
  verifyToken   String?
  optionalPhone Bb_optionalPhone[]

  address Bb_address[] @relation("UserAddressRelation")

  agentProfile Bb_agentProfile?
  bookings     Bb_booking[]

  platformReviews Bb_platformReview[] // ‚Üê ADD THIS
  agentReviews    Bb_agentReview[] // optional future relation
  packageReviews  Bb_packageReview[] // optional future relation
  notifications   Bb_notification[]
}

model Bb_optionalPhone {
  id               String  @id @default(cuid())
  phoneNumber      String  @unique
  isVerifyedNumber Boolean @default(false)
  userId           String
  user             Bb_user    @relation(fields: [userId], references: [id])
}

model Bb_agentProfile {
  id          String      @id @default(cuid())
  userId      String      @unique
  companyName String
  description String?
  

  //gvt id for verification
  aadharNumber String
  panNumber    String?
  gstNumber    String?

  //relation to the document 
  documents Bb_document[]
  //relation to travel packages
 packages Bb_travelPackage[]


  bannerImageId String? @unique
  bannerImage Bb_image?        @relation("AgentBannerImage", fields: [bannerImageId], references: [id])

  user        Bb_user          @relation(fields: [userId], references: [id])
  reviews     Bb_agentReview[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Bb_document {
  id             String       @id @default(cuid())
  documentType   DocumentType
  documentUrl    String
  documentFileId String?

  agentId String
  agent   Bb_agentProfile @relation(fields: [agentId], references: [id])
}

model Bb_address {
  id          String      @id @default(cuid())
  addressType AddressType @default(PERMANENT)
  country     String?
  state       String?
  district    String?
  pin         String?
  city        String?
  longitude   String?
  latitude    String?

  userId String?
  user   Bb_user?   @relation("UserAddressRelation", fields: [userId], references: [id])

  travelPackageId String?
  travelPackage   Bb_travelPackage? @relation("PackageAddressRelation", fields: [travelPackageId], references: [id])
}

model Bb_travelPackage {
  id                String @id @default(cuid())
  agentId           String
  title             String
  description       String
  pricePerPerson    Float
  advancedPerPerson Float

  discountAmount     Int? @default(0)
  discountPercentage Int? @default(0)

  withTax       Boolean? @default(false)
  taxPercentage Int?     @default(0)

  destination          String
  durationDays         Int
  startDate            DateTime?
  endDate              DateTime?
  bookingActiveFrom    DateTime
  bookingEndAt         DateTime
  packagePolicies      String    @default("NA")
  cancellationPolicies String    @default("NA")
  agent   Bb_agentProfile @relation(fields: [agentId], references: [id], onDelete: Cascade)
  packageBannerImageId String?   @unique
  PackageBannerImage   Bb_image?    @relation("PackageBannerImage", fields: [packageBannerImageId], references: [id])
  isBookingActive      Boolean   @default(true)
  isDeleted            Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  tags                 String[]

  address Bb_address[] @relation("PackageAddressRelation")

  reviews        Bb_packageReview[]
  itinerary      Bb_itineraryDay[]
  bookings       Bb_booking[]
  packagesImages Bb_image[]
}

model Bb_image {
  id        String   @id @default(cuid())
  imageUrl  String
  fileId    String?
  isDeleted Boolean? @default(false)
  createdAt DateTime @default(now())

  userProfile Bb_user? @relation("User_profileImage")
  agentBanner     Bb_agentProfile?  @relation("AgentBannerImage")
  packageBanner   Bb_travelPackage? @relation("PackageBannerImage")

  travelPackage   Bb_travelPackage? @relation(fields: [travelPackageId], references: [id])
  travelPackageId String?
  userId          String?
  agentId String?
}

model Bb_itineraryDay {
  id          String  @id @default(cuid())
  dayNumber   Int
  title       String
  description String?
  packageId   String

  package    Bb_travelPackage @relation(fields: [packageId], references: [id])
  hotelStay  Bb_hotelStay?
  meals      Bb_mealPlan?
  transports Bb_transport[]
  visits     Bb_visitPlace[]

  createdAt DateTime @default(now())

  @@unique([packageId, dayNumber])
}

model Bb_hotelStay {
  id             String       @id @default(cuid())
  hotelName      String
  checkIn        DateTime?
  checkOut       DateTime?
  address        String?
  wifi           Boolean?
  tv             Boolean?
  attachWashroom Boolean?
  acRoom         Boolean?
  kitchen        Boolean?
  itineraryDayId String       @unique
  itineraryDay   Bb_itineraryDay @relation(fields: [itineraryDayId], references: [id])
}

model Bb_mealPlan {
  id             String @id @default(cuid())
  itineraryDayId String @unique

  meals Bb_meal[] // 3 meals: breakfast, lunch, dinner

  itineraryDay Bb_itineraryDay @relation(fields: [itineraryDayId], references: [id])
}

model Bb_meal {
  id              String   @id @default(cuid())
  type            MealType
  mealPlanId      String
  mealDescription String?
  mealPlan        Bb_mealPlan @relation(fields: [mealPlanId], references: [id])

  @@unique([mealPlanId, type])
}

model Bb_transport {
  id           String        @id @default(cuid())
  fromLocation String
  toLocation   String
  mode         TransportMode // e.g., BUS, TRAIN, CAR
  startTime    DateTime
  endTime      DateTime

  itineraryDayId String
  itineraryDay   Bb_itineraryDay @relation(fields: [itineraryDayId], references: [id])
}

model Bb_visitPlace {
  id             String  @id @default(cuid())
  name           String
  address        String?
  description    String?
  visitTime      String?
  itineraryDayId String

  itineraryDay Bb_itineraryDay @relation(fields: [itineraryDayId], references: [id])
}

model Bb_booking {
  id          String @id @default(cuid())
  bookingCode String @unique

  userId    String
  packageId String

  numberOfTravelers Int @default(1)

  status        BookingStatus @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)

  baseAmount     Float //travel package per person amount      
  taxAmount      Float @default(0) //if tax is provided by the agent apply
  discountAmount Float @default(0) //if discount is provided by the agent apply

  totalAmount Float

  amountPaid Float @default(0)
  balanceDue Float

  fullPaymentDueAt DateTime? // alias for holdExpiresAt or explicit field

  // cancellation refund fields
  refundableAmount   Float? // computed at cancellation time
  cancellationReason String?
  cancelledAt        DateTime?
  cancelledBy        CancelledBy

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user          Bb_user          @relation(fields: [userId], references: [id])
  travelPackage Bb_travelPackage @relation(fields: [packageId], references: [id])

  payments Bb_payment[] // one-to-many
}

model Bb_payment {
  id          String        @id @default(cuid())
  bookingId   String
  type        PaymentType
  status      PaymentStatus @default(PENDING)
  amount      Float
  currency    String        @default("INR")
  provider    ProviderType? @default(OTHER)
  providerRef String?
  isRefund    Boolean?      @default(false)
  refundForId String? // optional link to original payment id if this is a refund

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking Bb_booking @relation(fields: [bookingId], references: [id])
}

model Bb_packageReview {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  packageId     String
  travelPackage Bb_travelPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)

  userId String
  user   Bb_user   @relation(fields: [userId], references: [id])

  @@unique([packageId, userId])
}

model Bb_agentReview {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  agentId String
  agent   Bb_agentProfile @relation(fields: [agentId], references: [id], onDelete: Cascade)

  userId String
  user   Bb_user   @relation(fields: [userId], references: [id])

  @@unique([agentId, userId])
}

model Bb_platformReview {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  createdAt DateTime @default(now())

  userId String @unique
  user   Bb_user   @relation(fields: [userId], references: [id])
}

model Bb_notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user Bb_user @relation(fields: [userId], references: [id])
}
